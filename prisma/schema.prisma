// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id      String   @id @default(uuid())
  email        String   @unique
  password     String
  birth_date   DateTime
  role         String // E/P/G (Empresa/Profissional/Gerente)
  phone_number String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  company      Company?
  professional Professional?
  tickets      Ticket[]
  address      Address[]

  @@map("users")
}

model Company {
  company_id    String   @id @default(uuid())
  user_id       String   @unique
  cnpj          String   @unique
  address       String
  fantasy_name  String
  social_reason String
  segment       String // Paisagismo, interiores, revestimentos...
  platform_1    String?
  platform_2    String?
  monthly_fee   Float
  commission    Float
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user    User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  budgets Budget[]
  sales   Sale[]

  @@map("companies")
}

model Address {
  address_id   String  @id @default(uuid())
  user_id      String? @unique
  desk_id      String?
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  zip_code     String
  country      String
  ibge_code    String

  User User? @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  Desk Desk? @relation(fields: [desk_id], references: [desk_id])

  @@map("addresses")
}

model Professional {
  professional_id           String   @id @default(uuid())
  user_id                   String   @unique
  desk_id                   String?
  cpf                       String   @unique
  name                      String
  gender                    String
  activity_area             String // Designer, Arquiteto...
  preferred_name            String?
  professional_registration String?
  social_network            String?
  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt

  user     User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  projects Project[]
  sales    Sale[]
  desk     Desk?

  @@map("professionals")
}

model Desk {
  desk_id         String   @id @default(uuid())
  professional_id String?  @unique
  cnpj            String   @unique
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  Address      Address[]
  Professional Professional? @relation(fields: [professional_id], references: [professional_id])

  @@map("desks")
}

model Project {
  project_id      String   @id @default(uuid())
  professional_id String
  title           String
  start_date      DateTime
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  professional Professional @relation(fields: [professional_id], references: [professional_id], onDelete: Cascade)
  budgets      Budget[]

  @@map("projects")
}

model Budget {
  budget_id   String   @id @default(uuid())
  project_id  String
  company_id  String?
  description String
  status      String   @default("pending") // pending, approved, rejected, finished
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  project Project  @relation(fields: [project_id], references: [project_id], onDelete: Cascade)
  company Company? @relation(fields: [company_id], references: [company_id], onDelete: Cascade)
  tickets Ticket[]
  sales   Sale?

  @@map("budgets")
}

model Ticket {
  ticket_id  String   @id @default(uuid())
  budget_id  String
  user_id    String
  message    String
  file_url   String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user   User   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  budget Budget @relation(fields: [budget_id], references: [budget_id], onDelete: Cascade)

  @@map("tickets")
}

model Sale {
  sale_id         String   @id @default(uuid())
  company_id      String
  professional_id String
  budget_id       String?  @unique
  value           Float
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  company      Company      @relation(fields: [company_id], references: [company_id], onDelete: Cascade)
  professional Professional @relation(fields: [professional_id], references: [professional_id], onDelete: Cascade)
  budget       Budget?      @relation(fields: [budget_id], references: [budget_id], onDelete: Cascade)

  @@map("sales")
}
